<apex:page controller="ctrlDataAnalysis" readonly="true">
<apex:includeScript value="{!URLFOR($Resource.Jquery_1_8_11, 'js/jquery-1.5.1.min.js')}" />
<apex:includescript value="{!URLFOR($Resource.DataTables1_7_5,'/DataTables-1.7.5/media/js/jquery.dataTables.js')}" />

<apex:form >

    <apex:actionFunction action="{!customanalyze}" name="apexOnAnalyze" rerender="pResults,debug,err" oncomplete="document.body.style.cursor='auto';" >
        <apex:param name="gtype" assignTo="{!gtype}" value=""  />
    </apex:actionFunction>
    
  		<apex:actionFunction action="{!sObjectType_onChange}" name="apexSobjectType_OnChange" rerender="pParams,err" oncomplete="document.body.style.cursor='auto';" >
        <apex:param name="sobjectType" assignTo="{!sobjectType}" value=""  />
    	</apex:actionFunction>  
    

    

	<apex:outputPanel id="err">
		<apex:pagemessages />
		<apex:outputPanel rendered="{!results!=null && results.size==recordLimit}">
		    <apex:pageMessage summary="The Maximum allowed Aggregate rows has been reach.  The counts and percentages are accurate however not all results are returned just the top {!recordLimit}." severity="warning" strength="3" />
		</apex:outputPanel>
	</apex:outputPanel>


	<apex:outputPanel id="debug" rendered="{!$CurrentPage.parameters.debug='1'}" >
		<apex:inputTextarea style="width:800px" value="{!soql}"/>
		<apex:commandButton action="{!customAnalyze}" value="Analyze" />
	</apex:outputPanel>


	<apex:outputPanel id="pResults">

	<apex:outputPanel rendered="{!results.size>0}" id="pDA">
	
	<apex:pageBlock id="pbDA" Title="Total Rows: {!totalRecords}">
	
		<apex:outputPanel id="pParams">
		
		<table width="100%">
			<tr><td style="width:150px; white-space: nowrap;"><b>sObject Type:</b></td>
			<td><apex:selectList id="sobjs" value="{!sobjectType}" multiselect="false" size="1" 
				onchange="javascript:document.body.style.cursor='wait'; apexSobjectType_OnChange(j$(esc('{!$Component.sobjs}')).val());" >
				<apex:selectOptions value="{!sobjectTypes}"/>
				</apex:selectList></td>
			<td rowspan="6" align="right" style="width:100%">
				<apex:chart data="{!pieData}" height="230px" width="400px">
					<apex:legend position="right" font="10px Helvetica" padding="1" spacing="0"/>
    				<apex:pieSeries labelField="name" dataField="data"/>
				</apex:chart>
			</td></tr>
			<tr><td><b>Field:</b></td>
				<td><apex:selectList id="flds" value="{!field}" multiselect="false" size="1" >
					<apex:selectOptions value="{!fields}"/>
				</apex:selectList></td></tr>
			<tr><td><b>Group By:</b></td>
			<td><apex:selectList id="grby" value="{!gtype}" multiselect="false" size="1" >
		            <apex:selectOption itemValue="" itemLabel="--None--"/>
		            <apex:selectOption itemValue="recordtype" itemLabel="RecordType"/>
		            <apex:selectOption itemValue="program" itemLabel="Program"/>
				</apex:selectList>
			</td></tr>
			<tr><td><b>Group By LIKE:</b></td>
			<td><apex:inputText value="{!groupByFilter}"/></td></tr>
			<tr><td colspan="2" style="width:100%"><hr/></td></tr>
			<tr><td colspan="2" align="middle"><apex:commandButton id="bAnalyze" value=" Analyze " rerender="pResults,debug,err" action="{!analyze}" onmousedown="document.body.style.cursor='wait';" oncomplete="document.body.style.cursor='auto';" title="Analyze"  /></td></tr>
			<tr><td colspan="3" style="width:100%"><hr/></td></tr>
			</table>
			</apex:outputPanel>
		<table class="daResults list" cellpadding="0" cellspacing="0" border="0" style="width:100%">
		
			<thead>
				<tr class="headerRow" style="width:100%">
				<apex:repeat value="{!results[0].fields}" var="f" id="hdrs">
		        	<th><apex:outputText value="{!f.name}" /></th>
		    	</apex:repeat>
		    	<th><apex:outputText value="cnt/total %" /></th>
		    	</tr>
		    </thead>	
		
		
		<apex:repeat value="{!results}" var="r" id="recs">
			<tr class="dataRow">
		    <apex:repeat value="{!r.fields}" var="f" id="flds">
	        	<td ><apex:outputText value="{!If(f.value==null,'<null>',f.value)}" /></td>
	    	</apex:repeat>
	    		<td><apex:outputText rendered="{!totalRecords!=0}" value="{!ROUND(r.count/totalRecords*100, 2)} %" /></td>
	    	</tr>
	    </apex:repeat>
	
		</table>
	</apex:pageBlock>
	
			<script type="text/javascript">
		
				var j$ = jQuery.noConflict();
				j$(document).ready(function(j$) {
				
				
			        j$('.daResults').dataTable( {
						"bPaginate": false,
						"bLengthChange": false,
						"bFilter": true,
						"bSort": true,
						"bInfo": false,
						"bStateSave": true,
						//"aaSorting": [[ 1, "asc" ][ 2, "asc" ]],
						"oLanguage": {
    						"sSearch": "Filter Results:"
  						},
						"bAutoWidth": false 
					});
				
				});
				function esc(myid) {return '#' + myid.replace(/(:|\.)/g,'\\\\$1');} 
			
			</script>
	</apex:outputPanel>

</apex:outputPanel>


</apex:form>
</apex:page>