<apex:page controller="ctrlMetadataDiff" docType="html-5.0" showheader="false" sidebar="false" standardStylesheets="false" cache="false">
<head>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
	
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.jsdifflib2,'diffview.css')}" />
	<script type="text/javascript" src="{!URLFOR($Resource.jsdifflib2,'diffview.js')}"></script>
	<script type="text/javascript" src="{!URLFOR($Resource.jsdifflib2,'difflib.js')}"></script>
	
<style type="text/css">
	body {font-size: 12px;font-family: Sans-Serif;}
	h2 {margin: 0.5em 0 0.1em;text-align: center;}
	.top {text-align: center;}
	.textInput {display: block;width: 49%;float: left;}
	textarea {width:100%;height:300px;}
	label:hover {text-decoration: underline;cursor: pointer;}
	.spacer {margin-left: 10px;}
	.viewType {font-size: 16px;clear: both;text-align: center;padding: 1em;}
	#diffoutput {width: 100%;}
</style>

<script type="text/javascript">

    var j$ = jQuery.noConflict();
    j$(document).ready(function() {
		showdiff();
    });

	var viewType=0, file1, file2;
	

		var byId = function (id) { return document.getElementById(id); }

       function showdiff() {
       		file1id=j$('.s1').val();
       		file2id=j$('.s2').val();
			ctrlMetadataDiff.getFiles(file1id,file2id,
				function(result, event){
					if(event.type != 'exception') {					
						var diffoutputdiv = byId("diffoutput");
    					while (diffoutputdiv.firstChild) diffoutputdiv.removeChild(diffoutputdiv.firstChild);
						file1 = difflib.stringAsLines(htmlDecode(result[0]));
						file2 = difflib.stringAsLines(htmlDecode(result[1]));
						renderDiff();
					}	
				});
		}

//htmlDecode:  this result does not get added to the DOM, so XSS is not an issue unless you place on the dom
function htmlDecode(value) { return (typeof value==='undefined') ? '' : j$('<div/>').html(value).text(); }

function renderDiff() {
		var diffoutputdiv = byId("diffoutput");
    	while (diffoutputdiv.firstChild) diffoutputdiv.removeChild(diffoutputdiv.firstChild);
		var sm = new difflib.SequenceMatcher(file1, file2);
		var opcodes = sm.get_opcodes();
		var contextSize = j$("#contextSize").val();
    	contextSize = contextSize ? contextSize : null;
		
		// build the diff view and add it to the current DOM
	    diffoutputdiv.appendChild(diffview.buildView({
	        baseTextLines: file1,
	        newTextLines: file2,
	        opcodes: opcodes,
	        baseTextName: "File 1",
	        newTextName: "File 2",
	        contextSize: contextSize,
	        viewType: j$("input:radio[name=viewtype]:checked").val()=='inline' ? 1 : 0
	    }));
	}
</script>
</head>
<body>


<apex:form >

	
	<div class="viewType">
		<label for="s1">File 1</label>
		<apex:selectList styleclass="s1" id="sl" value="{!file1id}" multiselect="false" size="1" onChange="showdiff();">
		<apex:selectOptions value="{!versions}"/>
		</apex:selectList>&nbsp;&nbsp;&nbsp;
		<label for="s2">File 2</label>
		<apex:selectList styleclass="s2" id="s2" value="{!file2id}" multiselect="false" size="1" onChange="showdiff();">
		<apex:selectOptions value="{!versions}"/>
		</apex:selectList>	
		<br/>
		<div class="top">
		<strong>Context size (optional):</strong> <input type="text" id="contextSize" value="" onChange="renderDiff();"/>
		</div>
		<input type="radio" name="viewtype" value="sidebyside" id="sidebyside" onclick="renderDiff();"/>
		<label for="sidebyside">Side by Side Diff</label>
		&nbsp; &nbsp;
		<input type="radio" name="viewtype" value="inline" id="inline" onclick="renderDiff();"/>
		<label for="inline">Inline Diff</label>
	</div>
	<div id="diffoutput"> </div>
	


</apex:form>	




</body>
</apex:page>