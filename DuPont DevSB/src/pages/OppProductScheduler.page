<apex:page id="pg" controller="ctrlOppProductScheduler" tabStyle="Opportunity" action="{!init}" language="{!if(ISNULL($CurrentPage.parameters.l),userLanguage,$CurrentPage.parameters.l)}">
<!--*******************************************************************************
Copyright Â© 2011 DuPont. All rights reserved. 
Author: Thomas Snyder
Email: thomas.snyder@usa.dupont.com, tom@3ddd.com
Description:  OppProductScheduler v1.1
Test Class: OppProducts_UT
TES20111018:    Updated 'Schedule Out of Range': more descriptive mouse over, updated retURL and 
                saveURL to return to ProductScheduler when completed with update.

TES20111103:    Products search to use Products.Opp.CurrencyIsoCode (was hardcoded USD)
TES20121003:    set apex:page[language] to use the users language, if not overwritten.
AB20150605: Get Record Type Name and User License Type to show/hide sales price
********************************************************************************-->
<apex:includeScript value="{!URLFOR($Resource.Jquery_1_8_11, 'js/jquery-1.5.1.min.js')}" />
<apex:includeScript value="{!URLFOR($Resource.Jquery_1_8_11, 'js/jquery-ui-1.8.11.custom.min.js')}" />
<apex:stylesheet value="{!URLFOR($Resource.Jquery_1_8_11,'css/sfdc3/jquery-ui-1.8.11.custom.css')}" />
<apex:includeScript value="{!$Resource.jQuery_numberformat}" /> 

<apex:variable var="locale" value="{!if(ISNULL($CurrentPage.parameters.l),userLanguage,$CurrentPage.parameters.l)}" />

<style>
    .deletedItem    { text-decoration:line-through; color:red; background-color:rgb(244,233,237); align:right; }
    .newItem        { background-color:rgb(238,247,241); }
</style>

<apex:pagemessages id="errmsgs"/>

<script type="text/javascript">
    var isDirty     = false; 
    var showConfirm = true;
    
    var j$ = jQuery.noConflict();
    j$(document).ready(function() {
         init();
     });
     
 window.onbeforeunload = askConfirm;
function askConfirm(){  
    if (isDirty && showConfirm){ 
        return "You have some unsaved changes.  Press OK to continue without saving." 
    }
}    


function esc(myid){return '#' + myid.replace(/(:|\.)/g,'\\\\$1');}   
    
function init() {
    showConfirm=true;
    j$('input,checkbox,textarea,radio,select').bind('change',function(event) { 
        isDirty = true; 
        this.style.background='#FFFFEE';
        });
    j$('input,checkbox,textarea,radio,select').bind('focus',function(event) { 
            j$(this).data('priorVal',j$(this).val());
        });     
    
        
    j$(':reset,:submit').bind('click',function(event) { isDirty = false });
    document.body.style.cursor='auto';
    showButtons(true);
    
}



//hide StartDT popup in case its the first element and gets focus
window.onload = function() { 
    j$('#datePicker').hide();
}


function onAddProduct(result, event) {
    onEvent(result, 'onAddProduct');
}


var lastFocusedElement;
function onRowEvent(result,event) {
    showButtons(false);
    isDirty=true;
    showConfirm=false;
    document.body.style.cursor = 'wait';
    apexOnRowEvent(result,event);
}


function onEvent(result,event) {
    showButtons(false);
    isDirty=true;
    showConfirm=false;
    document.body.style.cursor = 'wait';
    apexOnEvent(result,event);
}

function showButtons(show) {
    if (show) j$('.btn').show(); else j$('.btn').hide();
}
    
</script>
    
<apex:sectionHeader subtitle="{!products.Opp.Name} ({!products.Opp.CurrencyIsoCode})" title="Opportunity Product Schedule : {!products.schedTypeFriendlyName}"/> 


<apex:form id="f">

<apex:actionFunction name="apexOnRowEvent" action="{!jsonEvent}" reRender="grid" oncomplete="init();" status="statusDo">
        <apex:param name="result" assignTo="{!jsResult}" value=""  />
        <apex:param name="event" assignTo="{!jsEvent}" value=""  />
</apex:actionFunction>


<apex:actionFunction name="apexOnEvent" action="{!jsonEvent}" reRender="main,grid,errmsgs" oncomplete="init();" status="statusDo">
        <apex:param name="result" assignTo="{!jsResult}" value=""  />
        <apex:param name="event" assignTo="{!jsEvent}" value=""  />
</apex:actionFunction>


<apex:outputPanel id="main" >


<!-- ================================================================================
    Opp Schedule Settings
===================================================================================== -->
<apex:pageBlock title="{!$ObjectType.Opportunity.label}" lang="en_US">
<apex:pageBlockSection columns="1">
    <apex:pageBlockSectionItem rendered="{!(schedTypeSetting.displayType=='r')}" >
        <apex:outputLabel value="{!$ObjectType.OpportunityLineItemSchedule.label} {!$ObjectType.OpportunityLineItemSchedule.fields.Type.label}" />
        <apex:outputText value="{!products.schedType}"  />
    </apex:pageBlockSectionItem>

    <apex:outputField rendered="{!(durationSetting.displayType=='r')}" value="{!products.Opp.Contract_Duration__c}"  />
    <apex:inputField required="true" rendered="{!(durationSetting.displayType=='e')}" value="{!products.Opp.Contract_Duration__c}" onchange="onEvent(this.value,'onChangeDuration');" />

    <apex:outputField rendered="{!(startDTSetting.displayType=='r')}" value="{!products.Opp.ScheduleBaseDate__c}" />
    <apex:inputField required="true" id="startdt" rendered="{!(startDTSetting.displayType=='e')}" value="{!products.Opp.ScheduleBaseDate__c}" onchange="onEvent(this.value,'onChangeStartDT');" />

    <apex:outputField rendered="{!(schedUnitSetting.displayType=='r')}" value="{!products.Opp.Amount_Type__c}" />
    <apex:inputField required="true" rendered="{!(schedUnitSetting.displayType=='e')}" value="{!products.Opp.Amount_Type__c}" onchange="confirmSchedUnit(this);" />

    <apex:pageBlockSectionItem rendered="{!(pbookSetting.displayType=='r' || pbookSetting.displayType=='e')}">
        <apex:outputLabel value="{!$ObjectType.Pricebook2.label}"/>
        <apex:outputPanel styleclass="requiredInput" layout="block"><apex:outputPanel styleclass="requiredBlock" layout="block">
            <apex:selectList required="true" disabled="{!(pbookSetting.displayType=='r')}" id="pbs" value="{!products.Opp.PriceBook2Id}" multiselect="false" size="1"  onchange="return confirmPriceBook(this);"  >
                <apex:selectOptions value="{!PriceBooks}"/>
            </apex:selectList></apex:outputPanel></apex:outputPanel>
        </apex:pageBlockSectionItem>
</apex:pageBlockSection>
</apex:pageBlock>


<!-- ================================================================================
    Buttons
===================================================================================== -->
<apex:pageBlock mode="edit" title="{!$ObjectType.OpportunityLineItem.label}">

    <apex:pageBlockButtons location="top" >
        <apex:commandButton id="bsave" value="Save" action="{!save}" title="Save changes and return to Opportunity." onclick="disableOnSubmit();" onmousedown="showConfirm=false;"/>
        <apex:commandButton id="bqsave" value="Quick Save" action="{!quicksave}" rerender="main,grid,errmsgs" onclick="disableOnSubmit();" title="Save changes and remain on this page." onmousedown="showConfirm=false;wait(true);" oncomplete="wait(false);init();" status="statusDo"/>
        <apex:commandButton id="bcancel" value="Cancel" action="{!cancel}" onclick="disableOnSubmit();" immediate="true" />
            <script>
            function wait(on) {
                document.body.style.cursor = (on) ? 'wait' : 'auto';
                document.getElementById("{!$Component.bsave}").disabled=on;
                //document.getElementById("{!$Component.bqsave}").disabled=on;
                document.getElementById("{!$Component.bcancel}").disabled=on;
                }   
            
            function disableOnSubmit() {
                setTimeout('disableAfterTimeout();', 50);
                }
                
            function disableAfterTimeout() {
                var toDisable = document.getElementById("{!$Component.bsave}");
                toDisable.disabled = 'disabled';
                // Use the Salesforce CSS style to make the button appear disabled
                toDisable.className = 'btnDisabled';
                toDisable.value = "Saving..."
                
                toDisable = document.getElementById("{!$Component.bqsave}");
                toDisable.disabled = 'disabled';
                // Use the Salesforce CSS style to make the button appear disabled
                toDisable.className = 'btnDisabled';
                toDisable.value = "Saving..."
                
                toDisable = document.getElementById("{!$Component.bcancel}");
                toDisable.disabled = 'disabled';
                // Use the Salesforce CSS style to make the button appear disabled
                toDisable.className = 'btnDisabled';
                toDisable.value = "Saving..."
                }
            </script>
    </apex:pageBlockButtons>
    <br/>


<!-- ================================================================================
    Add Product
===================================================================================== -->
    <table style="width:600px" width="600px">
    <tr>
    <td><span style="white-space: nowrap"><b>Add {!$ObjectType.product2.label}:&nbsp;</b></span></td>
    <td style="width:100%">
            <apex:inputText id="getProds" style="width:400px">
                <c:autoComplete_Products priceBook="{!products.Opp.PriceBook2Id}" currency="{!products.Opp.CurrencyIsoCode}" acId="{!$Component.getProds}" onSelect="onAddProduct" schedType="{!products.schedTypeCode}"/>
            </apex:inputText></td> 
            <td ><span style="white-space: nowrap;color:#FF0000"><i>[Type Keyword to Search]</i></span></td>
    </tr>
    </table>
    
    <br/>
<!-- ================================================================================
    Start the grid
===================================================================================== -->
<apex:outputPanel id="grid" >
    <table class="list" style="width:100%" cellspacing="0" cellpadding="0" border="1">

    <thead>
  <!-- {!products.schedTypeCode} {!oppRecTypeName}{!loggedInUserType}{!hideSalesPrice} -->
        <tr class="headerRow">
            <th>Action</th>
            <th>{!$ObjectType.product2.fields.name.label}</th>
            <apex:outputPanel rendered="{!(products.schedTypeCode=='Z' || products.schedTypeCode=='Q') && hideSalesPrice == false}" layout="none">
                <th>{!$ObjectType.OpportunityLineItem.fields.UnitPrice.label}</th><!--AB20150605: Get Record Type Name and User License Type -->
            </apex:outputPanel>
            <apex:repeat value="{!products.scheduleMatrixLabels}" var="heading" id="matrixColumnHeadings">
                <th>{!heading}</th>
            </apex:repeat>
            <apex:outputPanel rendered="{!(revenueSetting.displayType=='r' || revenueSetting.displayType=='e')}" layout="none">
                 <th>{!$ObjectType.OpportunityLineItemSchedule.fields.Revenue.label} Sum</th>
            </apex:outputPanel>
            <apex:outputPanel rendered="{!(quantitySetting.displayType=='r' || quantitySetting.displayType=='e')}" layout="none">
                <th>{!$ObjectType.OpportunityLineItemSchedule.fields.Quantity.label} Sum</th>
                <th>{!$ObjectType.OpportunityLineItem.fields.Quantity.label}</th>
            </apex:outputPanel>   
            <th><span title="Total Quantity">{!$ObjectType.OpportunityLineItem.fields.TotalPrice.label}</span></th>        
            <th><span title="Line Description">{!$ObjectType.OpportunityLineItem.fields.Description.label}</span></th>
            
            <apex:outputPanel rendered="{!compSetting.displayType=='e'}" layout="none">
                <th>{!$ObjectType.OpportunityLineItem.fields.Competition__c.label}</th>
             </apex:outputPanel>     
        </tr>
    </thead>
        
        
    <tbody>
        
    <!-- ================================================================================
        Loop Products
    ===================================================================================== -->
    <apex:repeat value="{!products.items}" var="li" id="lineItems">
        
        
        <apex:outputPanel rendered="{!!li.isDeleted}" layout="none">

        <tr class="{!if(ISBLANK(li.oli.id),'newItem','')}">
            <!-- ==== Column: Action   ================================== -->
            <td class="actionColumn"><a title="Delete - {!li.OLI.PriceBookEntry.Product2.Name}" class="actionLink" href="#" onclick="javascript:onRowEvent('{!li.indx}','onDeleteRow');">Del</a></td>
            
            <!-- ==== Column: Product   ================================== -->
            <td>
            <apex:outputLink rendered="{!linkToProduct || ISBLANK(li.OLI.id)}" value="/{!li.OLI.PriceBookEntry.Product2Id}" target="_blank" style="width:230px">{!li.OLI.PriceBookEntry.Product2.Name}</apex:outputLink>
            <apex:outputLink rendered="{!(!linkToProduct) && (!ISBLANK(li.OLI.id))}" value="/{!li.OLI.Id}" target="_blank" style="width:230px">{!li.OLI.PriceBookEntry.Product2.Name}</apex:outputLink>
            <apex:outputLink rendered="{!li.scheduleOutofRange}" title="Schedule Out of Range" value="/oppitm/scheduleedit.jsp?id={!li.oli.id}&sUrl=%2F{!li.oli.id}&retURL=%2Fapex%2FOppProductScheduler?id={!oppid}&saveURL=%2Fapex%2FOppProductScheduler?id={!oppid}">
                    <img src="{!URLFOR($Resource.icons16,'attention1.png')}" alt="Schedule Out of Range" title="Schedule Out of Range - There are existing schedule records that do not match the expected schedule dates based on the scheduleBaseDate, duration and Amount Type.  To correct click on this warning icon to edit the schedule records to match the correct dates." />
                </apex:outputLink>
            </td>                
            
            <!-- ==== Column: UnitPrice   ================================== -->
            <apex:outputPanel rendered="{!(products.schedTypeCode=='Z' || products.schedTypeCode=='Q') && hideSalesPrice == false}" layout="none"><!-- AB20150605: Show Hide Sales Price-->
                    <td style="width:100px"><apex:inputField id="unitprice" required="true" value="{!li.oli.UnitPrice}" style="width:100px" >
                            <c:formatNumber itemId="{!$Component.unitprice}" locale="{!locale}"/> 
                    </apex:inputField></td>
            </apex:outputPanel>    
           
            <!-- ==== Column: Schedules   ================================== -->
            <apex:outputPanel rendered="{!li.schedulingNotEnabledOnProduct}" layout="none">
                <td colspan="{!products.duration}" style="color:red;"> 
                    <img src="{!URLFOR($Resource.icons16,'attention3.png')}" alt="Scheduling Not Enabled On Product" title="Scheduling Not Enabled On Product"/ >&nbsp;&nbsp;<i><b>Scheduling Not Enabled On Product</b></i>
                        </td>
            </apex:outputPanel>

            <apex:repeat value="{!li.schedules}" var="si">
                <apex:outputPanel rendered="{!(products.schedTypeCode=='R')}" layout="none">
                    <td style="width:100px">
                        <apex:inputField styleClass="revSched" id="schedRev" value="{!si.item.Revenue}" style="width:100px; background-color:{!IF(si.IsDirty,'#FFFFEE','')};" >
                            <c:formatNumber itemId="{!$Component.schedRev}" locale="{!locale}"/> 
                        </apex:inputField>
                        </td>
                </apex:outputPanel>
                <apex:outputPanel rendered="{!(products.schedTypeCode=='Q' || products.schedTypeCode=='Z')}" layout="none">
                    <td style="width:100px">
                        <apex:inputField id="qtySched" styleClass="qtySched" value="{!si.item.Quantity}" style="width:100px; background-color:{!IF(si.IsDirty,'#FFFFEE','')}">
                            <c:formatNumber itemId="{!$Component.qtySched}" locale="{!locale}"/> 
                        </apex:inputField>
                        </td>
                </apex:outputPanel>                
            </apex:repeat>

         <!-- ==== Column: Revenue  SUM   ================================== -->
         <apex:outputPanel rendered="{!revenueSetting.displayType=='r' || revenueSetting.displayType=='e'}" layout="none">
             <td style="width:50px;white-space: nowrap">
                <table cellpadding="0" cellspacing="0" border="0" style="border:0px;"><tr>
                    <td align="right" style="width:100%;border:0px;white-space: nowrap;align:right;">
                        <apex:outputText id="revSum" value="{!li.revenueSum}" styleClass="revSum" style="align:right;">
                            <c:formatNumber itemId="{!$Component.revSum}" locale="{!locale}"/>
                        </apex:outputText>
                    </td>
                    <td style="border:0px;white-space: nowrap;"><apex:image rendered="{!revenueSetting.displayType=='e'}" url="{!URLFOR($Resource.icons16,'calculate.png')}" alt="Recalculate/Establish Schedule" title="Recalculate/Establish Schedule" onClick="showReEstablish({rowIndex:'{!li.indx}'});"/></td>
                </tr></table>
                    <script>
                        var j$ = jQuery.noConflict();
                        j$('input.revSched').bind('change',function(event) {
                            var lineTotal=0.0;
                            j$(this).closest('tr').find(".revSched").each(function(i){
                                var v = j$.parseNumber(j$(this).val(),{locale:"{!locale}"});
                                lineTotal+=parseFloat(v);
                                if ("{!$CurrentPage.parameters.debug}"=="1")    alert('debug:calcSUM():'+j$(this).val()+':'+v+':'+lineTotal);
                            });
                            j$(this).closest('tr').find(".revSum").text(lineTotal);
                            j$(this).closest('tr').find(".revSum").format({locale:"{!locale}"});
                        });
                    </script>            
             </td>
         </apex:outputPanel>
         
           <!-- ==== Column: Quantity SUM   ================================== -->       
         <apex:outputPanel rendered="{!quantitySetting.displayType=='r' || quantitySetting.displayType=='e'}" layout="none">
             <td align="right" style="white-space: nowrap; padding:0px;align:right;"><table cellpadding="0" cellspacing="0" border="0" style="border:0px;width:100%;"><tr>
                <td align="right" style="width:100%;border:0px;white-space: nowrap;align:right;">
                        <apex:outputText id="qtySum" value="{!li.quantitySum}" styleClass="qtySum" style="align:right;">
                            <c:formatNumber itemId="{!$Component.qtySum}" locale="{!locale}"/>
                        </apex:outputText>              
                    </td>
                <td style="border:0px;white-space: nowrap;align:right;">
                <apex:image rendered="{!quantitySetting.displayType=='e'}" url="{!URLFOR($Resource.icons16,'calculate.png')}" alt="Recalculate/Establish Schedule" title="Recalculate/Establish Schedule" onClick="showReEstablish({rowIndex:'{!li.indx}'});"/></td>
             </tr></table>
             <script>
                    var j$ = jQuery.noConflict();
                    j$('input.qtySched').bind('change',function(event) {
                            var lineTotal=0.0;
                            j$(this).closest('tr').find(".qtySched").each(function(i){
                                var v = j$.parseNumber(j$(this).val(),{locale:"{!locale}"});
                                lineTotal+=parseFloat(v);
                                if ("{$CurrentPage.parameters.debug}"=="1") alert('debug:calcSUM():'+j$(this).val()+':'+v+':'+lineTotal);
                            });
                            j$(this).closest('tr').find(".qtySum").text(lineTotal);
                            j$(this).closest('tr').find(".qtySum").format({locale:"{!locale}"});
                        });
             </script> 
             </td>
         </apex:outputPanel>
         
            <!-- ==== Column: Quantity   ================================== -->
             <apex:outputPanel rendered="{!(quantitySetting.displayType=='r' || quantitySetting.displayType=='e')}" layout="none">
                <td align="right" style="width:100px;white-space: nowrap;align:right;"><apex:outputField value="{!li.OLI.Quantity}" Style="align:right;"/></td>
            </apex:outputPanel>

            
            <!-- ==== Column: Total Price   ================================== -->                      
            <td style="white-space: nowrap;padding:0px;"><table cellpadding="0" cellspacing="0" border="0" style="border:0px;"><tr>
               <!--  <td style="border:0px;"><apex:outputLink rendered="{!li.scheduleOutofRange}" title="Schedule Out of Range" value="/oppitm/scheduleedit.jsp?id={!li.oli.id}&sUrl=%2F{!li.oli.id}&retURL=%2Fapex%2FOppProductScheduler?id={!oppid}&saveURL=%2Fapex%2FOppProductScheduler?id={!oppid}">
                    <img src="{!URLFOR($Resource.icons16,'attention1.png')}" alt="Schedule Out of Range" title="Schedule Out of Range - There are existing schedule records that do not match the expected schedule dates based on the scheduleBaseDate, duration and Amount Type.  To correct click on this warning icon to edit the schedule records to match the correct dates." />
                </apex:outputLink></td> -->
                <td align="right" style="width:100%;border:0px;white-space: nowrap"><apex:outputField value="{!li.OLI.TotalPrice}" /></td>
            </tr></table></td>     
            
            <!-- ==== Column: LineDesc (future FieldSet...did not work w/ beta release) ================================== -->              
            <td style="width:150px"><apex:inputText value="{!li.OLI.Description}"/></td>
                
            <!-- ==== Column: Competition (future FieldSet...did not work w/ beta release) ================================== -->      
            <apex:outputPanel rendered="{!compSetting.displayType=='e'}" layout="none">
                <td style="width:100px;white-space: nowrap"><apex:inputField value="{!li.OLI.Competition__c}"/></td>
             </apex:outputPanel>
        </tr>
        </apex:outputPanel>
     
         <!-- =======================================================================================================================
        // DELETED ROW
        ======================================================================================================================== -->       
        <apex:outputPanel rendered="{!li.isDeleted}" layout="none">
        <tr Class="deletedItem">
            <td class="actionColumn"><img title="Undelete - {!li.OLI.PriceBookEntry.Product2.Name}" src="/img/func_icons/util/ileUndo16.gif" onclick="onRowEvent('{!li.indx}','onUndeleteRow');"/></td>

            <!-- ==== Column: Product   ================================== -->
            <td>
            <apex:outputLink rendered="{!linkToProduct || ISBLANK(li.OLI.id)}" value="/{!li.OLI.PriceBookEntry.Product2Id}" target="_blank" >{!li.OLI.PriceBookEntry.Product2.Name}</apex:outputLink>
            <apex:outputLink rendered="{!(!linkToProduct) && (!ISBLANK(li.OLI.id))}" value="/{!li.OLI.Id}" target="_blank" >{!li.OLI.PriceBookEntry.Product2.Name}</apex:outputLink>
            </td>                
 
            <!-- ==== Column: UnitPrice   ================================== -->
            <apex:outputPanel rendered="{!(products.schedTypeCode=='Z' || products.schedTypeCode=='Q')}" layout="none">
                    <td style="width:100px"><apex:outputField value="{!li.oli.UnitPrice}" style="width:100px"  /></td>
            </apex:outputPanel>    
           
           <!-- ==== Column: Schedules   ================================== -->
            <apex:outputPanel rendered="{!li.schedulingNotEnabledOnProduct}" layout="none">
                <td colspan="{!products.duration}" style="color:red;"> 
                        <img src="{!URLFOR($Resource.icons16,'attention3.png')}" alt="Scheduling Not Enabled On Product" title="Scheduling Not Enabled On Product" />&nbsp;&nbsp;<i><b>Scheduling Not Enabled On Product</b></i>
                        </td>
            </apex:outputPanel>
            <apex:repeat value="{!li.schedules}" var="si">              
                <apex:outputPanel rendered="{!(products.schedTypeCode=='R')}" layout="none">
                    <td align="right" style="width:100px"><apex:outputtext id="delrev" value="{!si.item.Revenue}" style="width:100px">
                        <c:formatNumber itemId="{!$Component.delrev}" locale="{!locale}"/>
                    </apex:outputtext>
                    </td>
                </apex:outputPanel>
                <apex:outputPanel rendered="{!(products.schedTypeCode=='Q' || products.schedTypeCode=='Z')}" layout="none">
                    <td align="right" style="width:100px"><apex:outputtext value="{!si.item.Quantity}" style="width:100px"/></td>
                </apex:outputPanel>  
            </apex:repeat>
            
            
            <!-- ==== Column: Revenue  SUM   ================================== -->   
            <apex:outputPanel rendered="{!revenueSetting.displayType=='r' || revenueSetting.displayType=='e'}" layout="none">      
                    <td align="right" style="width:10px;white-space: nowrap"><apex:outputText id="delrevsum" value="{!li.revenueSum}"><c:formatNumber itemId="{!$Component.delrevsum}" locale="{!locale}"/>
                    </apex:outputText></td>
            </apex:outputPanel>     
            
            <!-- ==== Column: Quantity SUM   ================================== --> 
            <apex:outputPanel rendered="{!quantitySetting.displayType=='r' || quantitySetting.displayType=='e'}" layout="none">      
                <td align="right" style="width:10px;white-space: nowrap"><apex:outputText value="{!li.quantitySum}" style="width:56px"/></td>
            </apex:outputPanel>

            <!-- ==== Column: Quantity   ================================== -->
             <apex:outputPanel rendered="{!quantitySetting.displayType=='r' || quantitySetting.displayType=='e'}" layout="none">
                <td align="right" style="width:10px;white-space: nowrap"><apex:outputField value="{!li.OLI.Quantity}" style="width:56px"/></td>
            </apex:outputPanel>

            <!-- ==== Column: Total Price   ================================== -->                      
            <td style="white-space: nowrap"><table cellpadding="0" cellspacing="0" border="0"><tr>
                <td style="border:0px;"></td>
                <td align="right" style="width:100%; border:0px;"><apex:outputText value="{!li.OLI.TotalPrice}" /></td>
            </tr></table></td>               
    
            <!-- ==== Column: Line Desc ================================== -->      
             <td><apex:outputText value="{!li.OLI.Description}"/></td>
             
             <!-- ==== Column: Competition (future FieldSet...did not work w/ beta release) ================================== -->                  
             <apex:outputPanel rendered="{!compSetting.displayType=='e'}" layout="none">
                <td><apex:outputField value="{!li.OLI.Competition__c}"/></td>
             </apex:outputPanel>
            
        </tr>
        </apex:outputPanel> 
          
        </apex:repeat>
          
        <apex:outputpanel rendered="{!products.items.size==0}" layout="none">
            <tr><td colspan="{!totalColumns}">No Products.</td></tr>
        </apex:outputpanel>         
        
        
        <tr style="background-color: #E1E0E0;">
            <td colspan="2" align="left">
                 <apex:actionstatus id="statusDo">
                    <apex:facet name="start"><img src="{!URLFOR($Resource.AjaxLoaders, 'snake_trans_16.gif')}"/> Processing...</apex:facet>
                </apex:actionstatus>
            </td>
            <td colspan="{!IF(products.schedTypeCode=='R',totalScheduleColumns+1,IF(quantitySetting.displayType=='n',totalScheduleColumns,totalScheduleColumns+3))}" align="right">
                <b>{!$ObjectType.Opportunity.label} {!$ObjectType.Opportunity.fields.Amount.label}:</b>
            </td>
            <td align="right"><b><apex:outputField value="{!products.opp.Amount}"/></b></td>
            <td>&nbsp;</td>
             <apex:outputPanel rendered="{!compSetting.displayType=='e'}" layout="none">
             <td>&nbsp;</td>
             </apex:outputPanel>
        </tr>
            </tbody>
    </table>   
</apex:outputPanel>  
    

     <br/>
</apex:pageBlock>

    <br/>

</apex:outputPanel>

    <br/>

<!-- =======================================================================================================================
// Dialogs
 ======================================================================================================================== -->       
<script>

    j$(function(){
            j$( ".confirmPriceBook" ).dialog({
                //resizable: false,
                //height:140,
                    modal: true,
                    autoOpen: false,
                    width: 600,
                    buttons: {
                        "Continue": function() { 
                            j$(this).dialog("close"); 
                            onEvent(dialogArgs.value,'onChangePriceBook');
                        }, 
                        "Cancel": function() { 
                            j$(this).dialog("close"); 
                            dialogArgs.style.background='#FFFFFF';
                            j$(dialogArgs).val(j$(dialogArgs).data('priorVal'));
                        } 
                    }
            });
            
            j$( ".confirmSchedUnit" ).dialog({
                //resizable: false,
                //height:140,
                    modal: true,
                    autoOpen: false,
                    width: 600,
                    buttons: {
                        "Continue": function() { 
                            j$(this).dialog("close"); 
                            onEvent(dialogArgs.value,'onChangeAmountType');
                        }, 
                        "Cancel": function() { 
                            j$(this).dialog("close"); 
                            dialogArgs.style.background='#FFFFFF';
                            j$(dialogArgs).val(j$(dialogArgs).data("priorVal"));
                        } 
                    }
            });
        j$( ".reEstablish" ).dialog({
                //resizable: false,
                //height:140,
                    modal: true,
                    autoOpen: false,
                    width: 600,
                    buttons: {
                        "Continue": function() { 
                            j$(this).dialog("close"); 
                            //if (j$.browser.mozilla) console.debug(dialogArgs);
                            onReEstablish(dialogArgs);
                        }, 
                        "Cancel": function() { 
                            j$(this).dialog("close"); 
                        } 
                    }
            });     
            
            
            
            
    });

    var dialogArgs=null;
    function confirmPriceBook(e) {dialogArgs=e; j$( ".confirmPriceBook" ).dialog( "open" );}
    function confirmSchedUnit(e) {dialogArgs=e; j$( ".confirmSchedUnit" ).dialog( "open" );}    
    function showReEstablish(e)  {dialogArgs=e; j$( ".reEstablish" ).dialog( "open" );} 


</script>

<div class="confirmPriceBook" style="display:none;" title="Confirmation Required"><p>You have modified the price book for this opportunity. All products related to this opportunity will be permanently deleted. Continue?</p></div>
<div class="confirmSchedUnit" style="display:none;" title="Confirmation Required"><p>You have modified the scheduled Unit (Amount Type) for this opportunity. All schedules for each product related to this opportunity will be deleted and reset to the new unit and duration. Continue?</p></div>
<div class="reEstablish" style="display:none;" title="Re-Establish Product Schedule">

<script>
function onReEstablish(dialogArgs) {
    showButtons(false);
    isDirty=true;
    showConfirm=false;
    document.body.style.cursor = 'wait';
    //alert(j$('.reEstOperation').val());
    var v = j$.parseNumber(dialogArgs.amount, { locale:"{!locale}" }).valueOf();
    //if (j$.browser.mozilla) console.debug(v);
    var amt=parseFloat(v);
    apexOnReEstablish(dialogArgs.rowIndex,amt,dialogArgs.operation,'onReEstablish');
}
</script>
<apex:actionFunction name="apexOnReEstablish" action="{!jsOnEvent}" reRender="grid,errmsgs,reest" oncomplete="init();" status="statusDo">
        <apex:param name="result"       assignTo="{!jsResult}"          value=""  />
        <apex:param name="amount"       assignTo="{!reEstAmount}"       value=""  />
        <apex:param name="operation"    assignTo="{!reEstOperation}"    value=""  />
        <apex:param name="event"        assignTo="{!jsEvent}"           value=""  />
</apex:actionFunction>

<apex:outputPanel id="reest">
<apex:pageBlock >
    <apex:pageBlockSection columns="1">
        <apex:pageBlockSectionItem >
            <apex:outputLabel value="{!$ObjectType.Opportunity.fields.Amount.label}" />
            <!--  <input type="text" onBlur="dialogArgs.amount=this.value;"/> -->
            <apex:outputPanel >
             <apex:inputText id="reEstAmount" value="{!reEstAmount}" styleClass="reEstAmount" onBlur="dialogArgs.amount=this.value;">
                <c:formatNumber itemId="{!$Component.reEstAmount}" locale="{!locale}"/>
            </apex:inputText>
            </apex:outputPanel>
        </apex:pageBlockSectionItem>
        
        <apex:pageBlockSectionItem >
            <apex:outputLabel value="Operation"/>
                <apex:SelectRadio id="aradio" value="{!reEstOperation}" styleClass="reEstOperation" layout="pageDirection" onChange="dialogArgs.operation=this.value;">
                        <apex:selectOption itemValue="E" itemLabel="Apply amount above to each schedule."/>
                        <apex:selectOption itemValue="D" itemLabel="Divide amount above evenly across all schedules."/>
                </apex:SelectRadio>             
            </apex:pageBlockSectionItem>
    </apex:pageBlockSection>
</apex:pageBlock>
</apex:outputPanel>
</div>

</apex:form>
<span style="color:white">{!locale}</span>
</apex:page>