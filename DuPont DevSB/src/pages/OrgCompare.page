<apex:page controller="ctrlOrgCompare" readonly="true">
<apex:includeScript value="{!URLFOR($Resource.Jquery_1_8_11, 'js/jquery-1.5.1.min.js')}" />
<apex:includescript value="{!URLFOR($Resource.DataTables1_7_5,'/DataTables-1.7.5/media/js/jquery.dataTables.js')}" />

<head>
<style>
    table.messageTable td { border-width:0px; } 
	body .pbBody table.list tr[class~=exact] td { color:black; } 
	body .pbBody table.list tr[class~=partial] td { color:blue; } 
	body .pbBody table.list tr[class~=new] td { color:green; } 
	body .pbBody table.list tr[class~='missing'] td { color:red;} 
    body .pbBody table.list tr.dataRow table.messageTable td { border-width:0px; } 
    a.btn { text-decoration: none; padding: 4px 4px 4px 4px; }
	th:hover {cursor: hand;}
</style>

</head>


<apex:sectionHeader title="Compares the metadata between two orgs" subtitle="Org Compare" />
<br></br>

	<apex:outputPanel rendered="{!$CurrentPage.parameters.debug='1'}" id="debug" style="width:100%">
		mdfolder: {!mdfolder}<br/>
		mdtype: {!mdtype}<br/>
		mddescr: {!mdDescr}<br/>
	</apex:outputPanel>  
	 
	<apex:outputPanel id="err" style="width:100%">
		<apex:pageMessages />
	</apex:outputPanel>   
	<apex:outputPanel rendered="{!!ISNULL(session) && $CurrentPage.parameters.debug='1'}" id="pAdvComp">
	
	<apex:form >
	<apex:pageBlock id="pb" title="Debug Console" >
	    <apex:pageBlockButtons location="bottom" >
			<apex:commandButton id="badvCompare" value="Compare" rerender="body,debug,err,pAdvComp" action="{!Compare}" title="Compare" /> 
	    </apex:pageBlockButtons>
		<apex:pageBlockSection columns="1">
			<apex:pageBlockSectionItem >
				<apex:outputLabel value="Metadata Type"/>
				<apex:inputText value="{!mdtype}" />
			</apex:pageBlockSectionItem>
			<apex:pageBlockSectionItem >
				<apex:outputLabel value="Folder"/>
				<apex:inputText value="{!mdfolder}" />
			</apex:pageBlockSectionItem>
			<apex:pageBlockSectionItem >
				<apex:outputLabel value="Filter (startswith)"/>
				<apex:inputText value="{!mdfilter}" />
			</apex:pageBlockSectionItem>
		</apex:pageBlockSection>
	</apex:pageBlock>
	</apex:form>
	</apex:outputPanel>

	<apex:outputPanel id="body">
	<apex:form >
	<!-- 
	Login Section
	 -->
	<apex:outputPanel rendered="{!ISNULL(session)}"  id="plogin">
	<apex:pageBlock id="pb" title="Enter Org Credentials for Org B.  (Org A = Current Org)" >
	    <apex:pageBlockButtons location="bottom" >
	        <apex:commandButton id="bLogin" value="Login" rerender="body,debug,err" action="{!Login}" title="Login" 
	        onmousedown="document.body.style.cursor='wait';" oncomplete="document.body.style.cursor='auto';" />
	    </apex:pageBlockButtons>
		<apex:pageBlockSection columns="1">
			<apex:pageBlockSectionItem >
				<apex:outputLabel value="Is Sandbox?"/>
				<apex:inputCheckBox value="{!isSandbox}"/>
			</apex:pageBlockSectionItem>
			<apex:pageBlockSectionItem >
				<apex:outputLabel value="User Name"/>
				<apex:inputText value="{!un}" style="width:300px"/>
			</apex:pageBlockSectionItem>
			<apex:pageBlockSectionItem >
				<apex:outputLabel value="Password"/>
				<apex:inputSecret value="{!pw}"/>
			</apex:pageBlockSectionItem>
		</apex:pageBlockSection>
	</apex:pageBlock>
	</apex:outputPanel>



	<!-- 
	Compare Results
	 -->
	<apex:outputPanel rendered="{!!ISNULL(session)}"  id="pCompare">
	
    <apex:actionFunction action="{!Compare}" name="apexOnCompare" rerender="pCompare,debug,err" oncomplete="document.body.style.cursor='auto';" >
        <apex:param name="mdfolder" assignTo="{!mdfolder}" value=""  />
        <apex:param name="mdtype" assignTo="{!mdtype}" value=""  />
        <apex:param name="mdfilter" assignTo="{!mdfilter}" value=""  />
    </apex:actionFunction>
    
    <!--  <apex:variable var="backTo" value="{!CASE(mdtype,â€‹'Dashboard','DashboardFolder','Document','DocumentFolder', 'Report', 'ReportFolder', 'EmailTemplate','EmailFolder', 'CustomObject')}" />-->
    <apex:pageBlock title="Type: {!mdType} Folder: {!mdFolder}" >
     
        <apex:pageBlockButtons location="top" >
  			<apex:outputPanel rendered="{!(mdfolder=='')}"><b>Metadata Type</b>&nbsp;<apex:selectList id="s3" value="{!rootMetadataType}" multiselect="false" size="1" 
  				onchange="javascript:document.body.style.cursor='wait'; apexOnCompare('',j$(esc('{!$Component.s3}')).val());" >       
				<apex:selectOptions value="{!metadataTypes}"/>
			</apex:selectList></apex:outputPanel>
			
			
				<apex:selectList rendered="{!parentType=='CustomObject'}"  id="soChildType" value="{!mdtype}" multiselect="false" size="1" 
						onchange="javascript:document.body.style.cursor='wait'; apexOnCompare('{!mdfolder}',j$(esc('{!$Component.soChildType}')).val());" >
						<apex:selectOptions value="{!SObjectChildTypes}"/>
				</apex:selectList>			

			<apex:outputLink rendered="{!!ISNULL(parentType)}" styleclass="btn" value="javascript:document.body.style.cursor='wait'; apexOnCompare('','{!parentType}','');" >Back to {!parentType}</apex:outputLink>		
			
			
			<!-- 
			<apex:outputLink rendered="{!(mdtype=='Dashboard')}" styleclass="btn" value="javascript:document.body.style.cursor='wait'; apexOnCompare('','DashboardFolder','');" >Back to DashboardFolder</apex:outputLink>		
			<apex:outputLink rendered="{!(mdtype=='EmailTemplate')}" styleclass="btn" value="javascript:document.body.style.cursor='wait'; apexOnCompare('','EmailFolder','');" >Back to EmailFolder</apex:outputLink>		
			<apex:outputLink rendered="{!(mdtype=='Report')}" styleclass="btn" value="javascript:document.body.style.cursor='wait'; apexOnCompare('','ReportFolder','');" >Back to ReportFolder</apex:outputLink>		
			<apex:outputLink rendered="{!(mdtype=='Document')}" styleclass="btn" value="javascript:document.body.style.cursor='wait'; apexOnCompare('','DocumentFolder','');" >Back to DocumentFolder</apex:outputLink>		
			<apex:outputLink rendered="{!mdfolder!=''&&mdtype!='Dashboard'&&mdtype!='EmailTemplate'&&mdtype!='Report'&&mdtype!='Document'}" styleclass="btn" value="javascript:document.body.style.cursor='wait'; apexOnCompare('','CustomObject','');" >Back to CustomObject</apex:outputLink>		
			-->
			
			<apex:commandButton rendered="{!(mdfolder=='')}" id="bLogout" value=" Logout of Org B " action="{!LogoutB}" title="Logout of Org B" />
		<apex:commandButton id="refCompare" value=" Refresh " rerender="body,debug,err" action="{!Compare}" title="Compare"  /> <apex:inputCheckBox value="{!showExacts}" /> show exact? 
    	</apex:pageBlockButtons>
    	
    		
		<!--  Differences: {!compare.totalDiffs}/{!compare.total} -->
		<table class="mdcompare list" cellpadding="0" cellspacing="0" border="0" style="width:100%">
		<thead>
			<tr class="headerRow" style="width:100%">
			<th>Action(s)</th>
			<th>Type</th>
			<th>API Name</th>
			<th>Org A lastMod</th>
			<th>Org B lastMod</th>
			<th>match Type</th>
			</tr>
		</thead>
		<tbody>
		<apex:repeat id="row" value="{!compare.blocks}" var="b">
		<apex:repeat id="row" value="{!b}" var="r">
			<tr class="dataRow {!r.matchType}">
				<td>
					<apex:outputPanel rendered="{!(mdtype=='CustomObject')}" id="pActCustomObj">
						subType:&nbsp;
						<apex:selectList id="soChildType" value="{!mdtype}" multiselect="false" size="1" 
							onchange="javascript:document.body.style.cursor='wait'; apexOnCompare('{!r.a.fullname}',j$(esc('{!$Component.soChildType}')).val());" >
							<apex:selectOptions value="{!SObjectChildTypes}"/>
							</apex:selectList>
					</apex:outputPanel>
					<apex:outputPanel rendered="{!(mdtype=='CustomField')}" id="pActFieldObj">				
						<apex:outputLink Styleclass="btn" value="/apex/dataAnalysis?fname={!r.a.fullname}" target="_blank">Analyze Data..</apex:outputLink>
						<!-- <apex:outputLink Styleclass="btn" value="/apex/dataAnalysis?fname={!r.a.fullname}&gtype=recordtype" target="_blank">by RecordType</apex:outputLink>
						<apex:outputLink Styleclass="btn" value="/apex/dataAnalysis?fname={!r.a.fullname}&gtype=program" target="_blank">by Program</apex:outputLink> -->
					</apex:outputPanel>	
					<apex:outputPanel rendered="{!(mdtype=='DashboardFolder')}" >				
						<apex:outputLink styleClass="btn" value="javascript:document.body.style.cursor='wait'; apexOnCompare('{!r.a.fullname}','Dashboard','');" >Compare Dashboards</apex:outputLink>
					</apex:outputPanel>
					<apex:outputPanel rendered="{!(mdtype=='DocumentFolder')}" >				
						<apex:outputLink styleClass="btn" value="javascript:document.body.style.cursor='wait'; apexOnCompare('{!r.a.fullname}','Document','');" >Compare Documents</apex:outputLink>
					</apex:outputPanel>
					<apex:outputPanel rendered="{!(mdtype=='ReportFolder')}" >				
						<apex:outputLink styleClass="btn" value="javascript:document.body.style.cursor='wait'; apexOnCompare('{!r.a.fullname}','Report','');" >Compare Reports</apex:outputLink>
					</apex:outputPanel>	
					<apex:outputPanel rendered="{!(mdtype=='EmailFolder')}">				
						<apex:outputLink styleClass="btn" value="javascript:document.body.style.cursor='wait'; apexOnCompare('{!r.a.fullname}','EmailTemplate','');" >Compare EmailTemplates</apex:outputLink>
					</apex:outputPanel>	
					<apex:outputPanel rendered="{!(mdtype=='Workflow' && mdFolder=='')}">				
						<apex:outputLink styleClass="btn" value="javascript:document.body.style.cursor='wait'; apexOnCompare('{!r.a.fullname}','Workflow','');" >details...</apex:outputLink>
					</apex:outputPanel>	
				</td>	
				<td><apex:outputText value="{!r.type}" /></td>
				<td><apex:outputText value="{!r.name}"/></td>	
				<td>	
				   <apex:outputText value="{0,date,yyyy.MM.dd HH:mm:ss z}" title="{!r.a}">
						<apex:param value="{!r.a.lastModifiedDate}" /></apex:outputText>
				</td>	
				<td> 
				<apex:outputText value="{0,date,yyyy.MM.dd HH:mm:ss z}" title="{!r.b}">
					<apex:param value="{!r.b.lastModifiedDate}" /></apex:outputText>
   				</td>	
				<td><apex:outputText value="{!r.matchtype}" /></td>	
			</tr>
		</apex:repeat></apex:repeat>
		</tbody>
		</table>

	</apex:pageBlock>

		<script type="text/javascript">
		
			var j$ = jQuery.noConflict();
			j$(document).ready(function(j$) {
		        j$('.mdcompare').dataTable( {
					"bPaginate": false,
					"bLengthChange": false,
					"bFilter": true,
					"bSort": true,
					"bInfo": false,
					"bStateSave": true,
					"aaSorting": [[ 2, "asc" ],[ 3, "asc" ]],
					"bAutoWidth": false 
				});
			});
			function esc(myid) {return '#' + myid.replace(/(:|\.)/g,'\\\\$1');} 
		</script>
    </apex:outputPanel>
    
</apex:form>
	
	</apex:outputPanel>



</apex:page>